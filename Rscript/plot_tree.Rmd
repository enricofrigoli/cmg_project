---
title: "Tree with heatmap"
author: "enrico frigoli"
date: '2022-04-10'
output:
  github_document:
    toc: true
---

```{r}
library(ggplot2)
library(ggtree)
library(ggnewscale)
```

```{r}
bin_metadata <- read.csv('~/Desktop/lecture_notes/microbial_genomics_segata/cmg_project/data/SGB14797_bin_data.tsv', sep = '\t')
samples <- read.csv('~/Desktop/lecture_notes/microbial_genomics_segata/cmg_project/data/SGB14797_metadata.tsv', sep = '\t')
```

```{r}
##########################################
### Create my new metadata
##########################################

extr_bins <- bin_metadata[,1:2] # extract needed data from bin metadata

colnames(extr_bins) <- c('name', 'sampleID')

extr_sample <- samples[, c(2,5,7,9,10,11)] # extract needed data from sample metadata

extr_sample <- rbind(extr_sample, c('GCA_011405655.fna', 'reference genome', NA))  # manual addition of infos
extr_sample <- rbind(extr_sample, c("GCA_009755265.fna", 'reference genome', NA))  # manual addition of infos


final <- dplyr::left_join(extr_bins, extr_sample, by = "sampleID")    # join


tree <- read.tree('~/Desktop/lecture_notes/microbial_genomics_segata/cmg_project/prokkaOutput/roary_out_noXieH_prank/core_gene.tre')     # build tree


final[order(final$name),]      # sort by name, since sample names must match leaf label in the tree
filenames <- tree$tip.label
filenames <- sort(filenames)
final <- cbind(filenames, final)  # add filenames to ensure the match between tip.label and the metadata (the order doesn't matter)

row.names(final) <- tree$tip.label  # row names must match tip.label for data to be plot in the heatmap

final[is.na(final)] <- 'unknown'   # remove na
final$non_westernized[final$non_westernized == 'N'] <- 'no'    # homogenize values
final

```



```{r}
############## Build tree

final_tree <- ggtree(tree,
       layout = "rectangular") %<+% final +    # links your metadata to the graph
     geom_tiplab(aes(label = label), offset = 0.001) +               
     #geom_tiplab2(aes(label = study_condition)) +
     geom_tippoint(aes(color = country))
final_tree

p1 <- gheatmap(final_tree, final[,c(4,8)],          # select data to plot in the heatmap
         offset = 0.05,         # distance of heatmap from tree tips
         width = 0.1,           # the width of the heatmap
         font.size = 3,         # the font size of the column headers
         colnames_position = "top",
         colnames_angle = 90,
         custom_column_labels = c('disease', 'non_westernized'),
         legend_title = 'Metadata')
p1
ggsave('myplot.png')

```


